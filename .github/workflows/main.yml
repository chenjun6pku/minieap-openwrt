name: Build minieap IPK for OpenWrt 24.10

on:
  workflow_dispatch:          # 手动触发（最常用）
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false          # 不要一个失败就停全部，方便调试
      matrix:
        include:                # 用 include 方式，便于为每个架构指定对应容器
          - arch: x86_64
            container: ghcr.io/openwrt/sdk:24.10.0-x86-64     # 或改成 24.10.5-x86-64 如果已发布
          - arch: mips_24kc
            container: ghcr.io/openwrt/sdk:24.10.0-mips_24kc
          - arch: aarch64_generic
            container: ghcr.io/openwrt/sdk:24.10.0-aarch64_generic
          # 如需更多架构，可继续添加，例如：
          # - arch: arm_cortex-a7
          #   container: ghcr.io/openwrt/sdk:24.10.0-arm_cortex-a7

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # 需要完整历史，用于 feeds

      - name: Build minieap only with official SDK 24.10
        uses: openwrt/gh-action-sdk@main
        env:
          CONTAINER: ${{ matrix.container }}   # 指定精确的 24.10 SDK 容器
          ARCH: ${{ matrix.arch }}             # 纯架构名
          PACKAGES: minieap                    # ← 关键！只编译 minieap 及其直接依赖，避免构建 rust 等无关 host 包
          # 如需同时编译多个包，可改成：PACKAGES: "minieap luci-proto-minieap"
          # INDEX: 1                           # 如果想生成 Packages 索引文件，可开启
          # IGNORE_ERRORS: 1                   # 如果部分依赖有问题，可临时开启忽略

      - name: Upload produced .ipk artifacts
        uses: actions/upload-artifact@v4
        with:
          name: minieap-ipk-${{ matrix.arch }}
          path: bin/packages/**/*.ipk          # 通常在 bin/packages/*/minieap/*.ipk
          if-no-files-found: warn              # 如果没找到文件，给警告但不失败 job
